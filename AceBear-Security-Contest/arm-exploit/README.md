# arm-exploit

```
Arch:     arm-32-little
RELRO:    Partial RELRO
Stack:    Canary found
NX:       NX enabled
PIE:      No PIE (0x10000)
```

I solve this challenge to practice how arm exploit work.

## Analysis

This challenge is an echo server. Based on login identity, there are two types of echo function, `guestecho` and `rootecho`. There is a buffer overflow vulnerability in latter one.  
Another vulnerability in both functions is that when type echo command, it just print our input on stack, where is full of uninitialized data. We can leak canary and stack address from here.

## Exploit

To utilize the buffer overflow, we must become root. This can not be done with the `login` function since the unknown random password. Therefore, we have to make `uid` be 0 and `user` be `"root"` manually.

```c
memset(&s, 0, 0x30u);
printf("New username: ");
secure_read(&s, 0x20u);
strcpy(user, &s);
```

<pre>
0x2209c &lt;user&gt;:     <b>0x41414141      0x41414141      0x41414141      0x41414141</b>
0x220ac &lt;user+16&gt;:  <b>0x41414141      0x41414141      0x41414141      0x41414141</b>
0x220bc &lt;user+32&gt;:  0x000000<b>00</b>      0x00000001      0x00000000      0x00000000
                        uid
</pre>

This can be done by using `change_username` twice. First change name to full 0x20 character, the `uid` variable will be overwrite to 0 by `strcpy` for null-terminate. Then just change name to `"root"`.

Now we can craft the first ROP chain. I plan to leak libc address first *(I assume the libc is available)*, then read second ROP chain to where the first one ended, whose job is to open a shell.  
For arm calling convention, first three arguments to function call are passed by registers `r0`, `r1` and `r2`. Based on this, I found following gadgets useful:

* `pop {r3, pc}`
* `pop {r4, r5, r6, r7, r8, sb, sl, pc}`
* `mov r2, sb ; mov r1, r8 ; mov r0, r7 ; blx r3 ; `  
`cmp r4, r6 ; bne #0x11080 ; pop {r4, r5, r6, r7, r8, sb, sl, pc}`

We can use them in order `1 -> 2 -> 3 -> 1 -> 3 -> 1 -> 3 -> ...` to set up and call anticipated functions perfectly in succession, and finally open shell.
